<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Pagination - 다른 페이지에 같은 record가 나오는 문제 &middot; Doohyun Kim
    
  </title>
  <!-- meta -->
  <link rel="author" href="https://plus.google.com/u/0/+sglee"/>
  <meta name="description" content="이성관 블로그">
  <meta name="naver-site-verification" content="589ef55a64f45cb4651dbf19ef610ca67fa3bdab"/>

  <!-- meta for facebook -->
  <meta property="og:url" content="http://localhost:4000/dev/rails/sql/2016/09/28/duplicated-records-of-sql-when-using-limit-and-offset/"/>
  <meta property="og:image" content="https://s3-us-west-2.amazonaws.com/sg-rails-sample-app/main.jpg"/>
  <meta property="og:description" content="이성관 블로그">

  <!-- CSS theme -->
  <!-- <link rel="stylesheet"  href="/css/poole.css"> -->
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <!-- CSS custom -->
  <link rel="stylesheet" href="/css/style.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Google Analytics Tag -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47572822-3', 'auto');
    ga('send', 'pageview');

  </script>

  <!-- bootstrap -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
  <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->
</head>


  <body>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <!-- <label for="sidebar-checkbox" class="sidebar-toggle"></label> -->

          <h3 class="masthead-title">
            <a href="/" title="Home">Doohyun Kim</a>
            <!-- <small>Blog</small> -->
          </h3>
          <div class="search-box">
            <form action="/search" method="get">
              <input type="text" id="search-box" name="query" placeholder="search">
            </form>
          </div>
          <div class="pull-right category-box">
            <a href="/about" class="category-menu"><small>ABOUT</small></a>
            <!-- <a href="/categories/dev" class="category-menu"><small>DEV</small></a> -->
            <!-- <a href="/categories/biz" class="category-menu"><small>BIZ</small></a> -->
            <a href="/categories/algorithm" class="category-menu"><small>ALROGITHM</small></a>
            <a href="/categories/database" class="category-menu"><small>DATABASE</small></a>
            <a href="/categories/frontend" class="category-menu"><small>FRONTEND</small></a>
            <a href="/categories/backend" class="category-menu"><small>BACKEND</small></a>
            <a href="/categories/growth" class="category-menu"><small>GROWTH</small></a>
          </div>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post__title">Pagination - 다른 페이지에 같은 record가 나오는 문제</h1>
  <div class="post__desc">
    <small class="post-date">Sep 28, 16</small>
    
      
        <small>dev</small>
      
    
      
        <small>rails</small>
      
    
      
        <small>sql</small>
      
    
  </div>
  <div class="post-content">
    <p><a href="https://github.com/mislav/will_paginate">will_paginate</a> gem을 이용하는데, 다른 페이지에 같은 record가 올라오는 경우가 있었다.
문제는 infinite scrolling을 넣으며 ajax로 다음 페이지를 붙이다 보니, 중복되게 반복되는 경우가 발생했다.
gem의 문제인가 해서 psql로 직접 sql을 날려보니, sql 결과에서도 같은 record가 나타났다.</p>

<h3 id="before">Before</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pnm_development=# SELECT  "sub_menus".*, "menus".name FROM "sub_menus" INNER JOIN "menus" ON "menus"."id" = "sub_menus"."menu_id" WHERE (menus.category_id = 1)  ORDER BY menus.name collate "C" asc LIMIT 10 OFFSET 10;

 id |    name    |         created_at         |         updated_at         | menu_id | description |        name         
----+------------+----------------------------+----------------------------+---------+-------------+---------------------
  6 | 물티슈     | 2016-08-10 14:12:25.575423 | 2016-08-10 14:12:25.575423 |       2 |             | 물티슈와 가제손수건
 49 | 바운서     | 2016-08-17 05:47:20.868362 | 2016-08-17 05:47:20.875056 |      16 |             | 바운서
 53 | 국산 분유  | 2016-08-29 06:54:39.305488 | 2016-08-29 06:54:39.315016 |      19 |             | 분유
 54 | 해외 분유  | 2016-08-29 06:54:54.123748 | 2016-08-29 06:54:54.130446 |      19 |             | 분유
 26 | 수유등     | 2016-08-10 14:12:25.698298 | 2016-08-10 14:12:25.698298 |       7 |             | 수유-모유
 23 | 수유패드   | 2016-08-10 14:12:25.681545 | 2016-08-10 14:12:25.681545 |       7 |             | 수유-모유
 22 | 수유브라   | 2016-08-10 14:12:25.677182 | 2016-08-10 14:12:25.677182 |       7 |             | 수유-모유
 21 | 수유복     | 2016-08-10 14:12:25.672055 | 2016-08-10 14:12:25.672055 |       7 |             | 수유-모유
 25 | 유두보호기 | 2016-08-10 14:12:25.694233 | 2016-08-10 14:12:25.694233 |       7 |             | 수유-모유
 20 | 수유쿠션   | 2016-08-10 14:12:25.668275 | 2016-08-10 14:12:25.668275 |       7 |             | 수유-모유
(10 rows)

pnm_development=# SELECT  "sub_menus".*, "menus".name FROM "sub_menus" INNER JOIN "menus" ON "menus"."id" = "sub_menus"."menu_id" WHERE (menus.category_id = 1)  ORDER BY menus.name collate "C" asc
 LIMIT 10 OFFSET 20;

 id |     name     |         created_at         |         updated_at         | menu_id | description |     name      
----+--------------+----------------------------+----------------------------+---------+-------------+---------------
 20 | 수유쿠션     | 2016-08-10 14:12:25.668275 | 2016-08-10 14:12:25.668275 |       7 |             | 수유-모유
 26 | 수유등       | 2016-08-10 14:12:25.698298 | 2016-08-10 14:12:25.698298 |       7 |             | 수유-모유
 19 | 유축기       | 2016-08-10 14:12:25.664174 | 2016-08-10 14:12:25.664174 |       7 |             | 수유-모유
 16 | 젖병소독기   | 2016-08-10 14:12:25.642145 | 2016-08-10 14:12:25.642145 |       6 |             | 수유-분유
 17 | 분유포트     | 2016-08-10 14:12:25.650437 | 2016-08-10 14:12:25.650437 |       6 |             | 수유-분유
 56 | 겉싸개       | 2016-08-29 13:41:40.355506 | 2016-08-29 13:41:40.363311 |      20 |             | 아기 의류
 55 | 속싸개       | 2016-08-29 13:41:29.740309 | 2016-08-29 13:41:29.748772 |      20 |             | 아기 의류
 33 | 기저귀정리함 | 2016-08-17 05:31:54.731063 | 2016-08-17 05:31:54.738381 |      12 |             | 아기가구
 34 | 아기수납장   | 2016-08-17 05:32:08.658293 | 2016-08-17 05:32:08.668742 |      12 |             | 아기가구
 39 | 힙시트       | 2016-08-17 05:33:23.976077 | 2016-08-17 05:33:23.983078 |      15 |             | 아기띠/힙시트
(10 rows)
</code></pre></div></div>

<p>문제가 되는 id 20번 record.</p>

<p>sql에서의 row 순서는 <code class="highlighter-rouge">ORDER BY</code>로 sort하지 않는 이상 정해져 있지 않다.<a href="http://stackoverflow.com/questions/15162593/postgresql-strange-collision-of-order-by-and-limit-offset">stackoverflow</a>
뭐가 나올지 알 수 없다는 말이네.</p>

<p>sub_menu에 대한 정렬을 추가해서 해결했다.</p>

<h3 id="after">after</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pnm_development=# SELECT  "sub_menus".*, "menus".name FROM "sub_menus" INNER JOIN "menus" ON "menus"."id" = "sub_menus"."menu_id" WHERE (menus.category_id = 1)  ORDER BY menus.name collate "C" asc, `sub_menus.name collate "C" asc LIMIT 10 OFFSET 10;

 id |    name    |         created_at         |         updated_at         | menu_id | description |        name         
----+------------+----------------------------+----------------------------+---------+-------------+---------------------
  6 | 물티슈     | 2016-08-10 14:12:25.575423 | 2016-08-10 14:12:25.575423 |       2 |             | 물티슈와 가제손수건
 49 | 바운서     | 2016-08-17 05:47:20.868362 | 2016-08-17 05:47:20.875056 |      16 |             | 바운서
 53 | 국산 분유  | 2016-08-29 06:54:39.305488 | 2016-08-29 06:54:39.315016 |      19 |             | 분유
 54 | 해외 분유  | 2016-08-29 06:54:54.123748 | 2016-08-29 06:54:54.130446 |      19 |             | 분유
 24 | 모유저장팩 | 2016-08-10 14:12:25.689986 | 2016-08-10 14:12:25.689986 |       7 |             | 수유-모유
 26 | 수유등     | 2016-08-10 14:12:25.698298 | 2016-08-10 14:12:25.698298 |       7 |             | 수유-모유
 21 | 수유복     | 2016-08-10 14:12:25.672055 | 2016-08-10 14:12:25.672055 |       7 |             | 수유-모유
 22 | 수유브라   | 2016-08-10 14:12:25.677182 | 2016-08-10 14:12:25.677182 |       7 |             | 수유-모유
 27 | 수유의자   | 2016-08-10 14:12:25.70253  | 2016-08-10 14:12:25.70253  |       7 |             | 수유-모유
 20 | 수유쿠션   | 2016-08-10 14:12:25.668275 | 2016-08-10 14:12:25.668275 |       7 |             | 수유-모유
(10 rows)

pnm_development=# SELECT  "sub_menus".*, "menus".name FROM "sub_menus" INNER JOIN "menus" ON "menus"."id" = "sub_menus"."menu_id" WHERE (menus.category_id = 1)  ORDER BY menus.name collate "C" asc, sub_menus.name collate "C" asc LIMIT 10 OFFSET 20;
 
 id |     name     |         created_at         |         updated_at         | menu_id | description |     name      
----+--------------+----------------------------+----------------------------+---------+-------------+---------------
 23 | 수유패드     | 2016-08-10 14:12:25.681545 | 2016-08-10 14:12:25.681545 |       7 |             | 수유-모유
 25 | 유두보호기   | 2016-08-10 14:12:25.694233 | 2016-08-10 14:12:25.694233 |       7 |             | 수유-모유
 19 | 유축기       | 2016-08-10 14:12:25.664174 | 2016-08-10 14:12:25.664174 |       7 |             | 수유-모유
 17 | 분유포트     | 2016-08-10 14:12:25.650437 | 2016-08-10 14:12:25.650437 |       6 |             | 수유-분유
 16 | 젖병소독기   | 2016-08-10 14:12:25.642145 | 2016-08-10 14:12:25.642145 |       6 |             | 수유-분유
 56 | 겉싸개       | 2016-08-29 13:41:40.355506 | 2016-08-29 13:41:40.363311 |      20 |             | 아기 의류
 55 | 속싸개       | 2016-08-29 13:41:29.740309 | 2016-08-29 13:41:29.748772 |      20 |             | 아기 의류
 33 | 기저귀정리함 | 2016-08-17 05:31:54.731063 | 2016-08-17 05:31:54.738381 |      12 |             | 아기가구
 34 | 아기수납장   | 2016-08-17 05:32:08.658293 | 2016-08-17 05:32:08.668742 |      12 |             | 아기가구
 38 | 아기띠       | 2016-08-17 05:33:14.93707  | 2016-08-17 05:33:14.942893 |      15 |             | 아기띠/힙시트
(10 rows)
</code></pre></div></div>


  </div>
</div>


  <div id="disqus_thread"></div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://sgwanlee.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


<style type="text/css">
  .post__desc {
    padding-top: 10px;
    padding-bottom: 10px;
    border-bottom: 1px dotted #DAD9D9;
  }
  .post__title {
    font-size: 1.6em;
  }
</style>

<!-- <div class="gdn-ads">
  <div class="gdn-ads-title">Advertisement</div>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <ins class="adsbygoogle"
       style="display:inline-block;width:728px;height:90px"
       data-ad-client="ca-pub-2507125479501117"
       data-ad-slot="8695918038"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div> -->

<!-- <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//house201.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 -->

<!-- <div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/05/30/2017-02-22-rails-active-record-query-interface-frequent-using/">
            
            <small>30 May 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/dev/react/javascript/2019/05/28/manage-constants-in-javascript/">
            Javascript에서 constants 관리하기
            <small>28 May 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/dev/react/eslint/vscode/2019/05/09/eslint-setup/">
            React + ESLint + VSCode
            <small>09 May 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
 -->
      </div>
    </div>
  </body>
</html>
